<!DOCTYPE html>
<html>
<head>
    <title>Detection</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<header>
    <h1>Detection</h1>
    <p id="connection">disconnected</p>
</header>
<body>
    <div style="position:relative;">
        <img id="video" style="display: block;">
        <canvas id="overlay" style="position:absolute; top: 0; left: 0;"></canvas>
    </div>
    <br>
    Last: <samp id="time">NA</samp><br>
    Center: <samp id="center">NA</samp><br>
    Size: <samp id="size">NA</samp><br>
    Color: <samp id="color">NA</samp><br>
    Contrast: <samp id="contrast">NA</samp> db<br>
    Threshold: <input type="number" min="-1000" max="0" value="-200" class="slider" id="threshold"> db<br>
    
    <script type="text/javascript">
        // Connect to the Socket.IO server
        const socket =  io();

        // Listen for 'connect' events and update the connection status
        socket.on('connect', function() {
            document.getElementById('connection').innerText = 'connected';
            document.getElementById('connection').style.color = 'green';
        });
        socket.on('disconnect', function() {
            document.getElementById('connection').innerText = 'disconnected';
            document.getElementById('connection').style.color = 'red';
        });
        
        // Listen for 'new_frame' events and update the image
        socket.on('camera_frame', function(data) {
            const parsedData = JSON.parse(data);
            document.getElementById('video').src = 'data:image/jpeg;base64,' + parsedData.image;
        });

        socket.on('detection', function(data){
            const parsedData = JSON.parse(data);

            const date = new Date(parsedData.time * 1000);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            const formattedTime = `${hours}:${minutes}:${seconds}`;
            
            document.getElementById('time').innerText = formattedTime;

            const canvas = document.getElementById('overlay');
            const context = canvas.getContext('2d');
            const video = document.getElementById('video');

            // Clear the canvas
            context.clearRect(0, 0, canvas.width, canvas.height);

            if(!parsedData.valid){
                document.getElementById("contrast").style.color = "red"
                return
            }
            else{
                document.getElementById("contrast").style.color = "green"
            }

            // Set canvas dimensions to match the video element
            canvas.width = video.clientWidth;
            canvas.height = video.clientHeight;

            // Calculate the center coordinates in pixels
            const centerX = parsedData.center[0];
            const centerY = parsedData.center[1];
            const centerXPixel = centerX * canvas.width;
            const centerYPixel = centerY * canvas.height;

            context.strokeStyle = 'white';

            // draw a cross
            context.beginPath();
            context.moveTo(centerXPixel, 0);
            context.lineTo(centerXPixel, canvas.height);
            context.stroke();
            context.beginPath();
            context.moveTo(0, centerYPixel);
            context.lineTo(canvas.width, centerYPixel);
            context.stroke();

            document.getElementById("center").innerText = `${centerX.toFixed(2)}, ${centerY.toFixed(2)}`;
            // document.getElementById("size").innerText = parsedData.size.toFixed(2);
            // document.getElementById("contrast").innerText = parsedData.contrast.toFixed(2);
            // document.getElementById("color").innerText = parsedData.color;
            // document.getElementById("color").style.color = `rgb(${parsedData.color})`;
            // document.getElementById('video').src = 'data:image/jpeg;base64,' + parsedData.weight;
            
        })

        document.getElementById("threshold").oninput = function(){
            socket.emit("message", "detector_setting "+JSON.stringify({ threshold: this.value}));
        }
    </script>
</body>
</html>